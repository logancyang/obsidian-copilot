name: Deploy to Gitee

on:
  push:
    tags:
      - '*'

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [20.x]
        # See supported Node.js release schedule at https://nodejs.org/en/about/releases/

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          tags: true
      # éªŒè¯tagæ˜¯å¦åœ¨masteråˆ†æ”¯ä¸Šæˆ–releaseä¸Š
      - run: |
          echo "ğŸ”– Tag name: $GITHUB_REF_NAME"
          echo "ğŸ”¨ Commit SHA: $GITHUB_SHA"

          # æŠŠ repo å®Œå…¨æ‹‰å¹³ï¼Œè®© `--contains` èƒ½ç”¨
          git fetch origin "refs/heads/*:refs/remotes/origin/*"

          # æ‰¾å‡º remote branches åŒ…å«è¿™ä¸ªæäº¤
          branches=$(git branch -r --contains $GITHUB_SHA | sed 's|origin/||g' )
          echo "Branches containing this commit: $branches"

          ok=false
          for b in $branches; do
            if [[ "$b" == "master" ]] || [[ "$b" == release/* ]] || [[ "$b" == YaQia_dev* ]]; then
              ok=true
              break
            fi
          done

          if [ "$ok" != "true" ]; then
            echo "âŒ Tag $GITHUB_REF_NAME not found on master or any release/* branch"
            exit 1
          else
            echo "âœ… Tag $GITHUB_REF_NAME is merged into a protected branch"
          fi
      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: "npm"
      - run: npm ci
      - run: npm run build --if-present
      # ä¸Šä¼ æ„å»ºäº§ç‰©
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: |
            main.js
            styles.css
            manifest.json

  deploy_to_gitee:
    runs-on: ubuntu-latest
    needs: build
    steps:
      # ä¸‹è½½æ„å»ºäº§ç‰©
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-output
          path: artifacts

      # è®¾ç½®SSHå¯†é’¥
      - name: Setup SSH Keys
        run: |
          # åˆ›å»º.sshç›®å½•
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          # ä¿å­˜ç§é’¥
          echo "${{ secrets.AI_LEARNING_ASSISTANT_PLUGINS_DIST }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

          # æ·»åŠ Giteeåˆ°known_hosts
          ssh-keyscan gitee.com >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

      # å…‹éš†Giteeä»“åº“ï¼ŒGiteeä»“åº“å¯¹åº”çš„è·¯å¾„éœ€è¦åœ¨GitHubä»“åº“ä¸­è®¾ç½®
      # https://docs.github.com/en/actions/writing-workflows/choosing-what-your-workflow-does/store-information-in-variables#defining-configuration-variables-for-multiple-workflows
      - name: Clone Gitee Repository
        run: |
          git clone "git@gitee.com:ai-learning-assistant-dev/ai-learning-assistant-plugin-dist.git" gitee-repo
          cd gitee-repo
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

      # åŒæ­¥æ–‡ä»¶
      - name: Sync files to Gitee
        run: |
          mkdir -p gitee-repo/"${{ github.repository }}"
          # å¤åˆ¶æ„å»ºæ–‡ä»¶
          cp artifacts/main.js gitee-repo/"${{ github.repository }}"
          cp artifacts/styles.css gitee-repo/"${{ github.repository }}"
          cp artifacts/manifest.json gitee-repo/"${{ github.repository }}"

          cd gitee-repo

          # æ£€æŸ¥å˜æ›´
          if [ -z "$(git status --porcelain)" ]; then
            echo "æ²¡æœ‰æ–‡ä»¶å˜æ›´"
          else
            echo "æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´ï¼Œå‡†å¤‡æäº¤..."
            # ä¿è¯æ—¶åŒºæ­£ç¡®
            export TZ='<UTC+8>-8'
            git add .
            git commit -m "è‡ªåŠ¨åŒæ­¥: $(date +'%Y-%m-%d %H:%M:%S')"

            # ä½¿ç”¨SSHæ¨é€
            git push origin master
            echo "åŒæ­¥å®Œæˆ!"
          fi
